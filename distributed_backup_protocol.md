
# 📄 분산 백업 시스템: 커스텀 TCP 프로토콜 스펙

> 버전: `v0.1`  
> 목적: 슬레이브 노드와 마스터 간의 파일 업로드/다운로드 통신을 위해 정의된 **애플리케이션 계층 프로토콜**

---

## ✅ 기본 원칙

- 연결 단위: TCP (연결 지향, 신뢰성 있음)
- 메시지 단위: 명령어 → 헤더 → 본문
- 통신 구조: **마스터가 클라이언트**, **슬레이브가 서버**

---

## 🧱 명령어 정의 (4바이트)

| 명령어 | 설명 |
|--------|------|
| `PUT ` | 마스터 → 슬레이브: 파일 업로드 요청 |
| `SEND` | 마스터 → 슬레이브: 파일 다운로드 요청 |

명령어는 항상 **정확히 4바이트**이며, 문자열 끝에 공백을 추가해 길이를 맞춥니다.

---

## 📦 공통 구조

```
[4B]  명령어        ("PUT " or "SEND")
[4B]  파일 이름 길이 (int, network byte order)
[N B] 파일 이름     (UTF-8, N바이트)
```

- **`PUT` 명령어의 경우**: 추가로 다음 정보 포함
  ```
  [8B]  파일 크기 (long, network byte order)
  [M B] 파일 내용 (M == 파일 크기)
  ```

---

## 📤 PUT 명령어 흐름 (업로드)

1. 마스터 → 슬레이브:
```
"PUT "
<int: 파일명 길이>
<파일명>
<long: 파일 크기>
<파일 데이터>
```

2. 슬레이브는 해당 파일명을 파일로 저장  
3. 슬레이브는 저장 완료 후 소켓 종료 (또는 응답 가능)

---

## 📥 SEND 명령어 흐름 (다운로드)

1. 마스터 → 슬레이브:
```
"SEND"
<int: 파일명 길이>
<파일명>
```

2. 슬레이브는 해당 파일을 열고 다음과 같이 응답:
```
<long: 파일 크기>
<파일 데이터>
```

✳️ 슬레이브가 파일을 못 찾는 경우, 크기를 -1로 응답해도 됨

---

## 🧪 예시 바이트 스트림 (예: PUT, "chunk1", 10바이트)

```
50 55 54 20               // "PUT "
00 00 00 06               // 파일명 길이: 6
63 68 75 6E 6B 31         // "chunk1"
00 00 00 00 00 00 00 0A   // 파일 크기: 10바이트
<10바이트 파일 데이터>
```

---

## 🧯 에러/예외 처리 (슬레이브 응답)

| 상황 | 슬레이브 행동 |
|------|---------------|
| 파일 없음 (SEND) | 파일 크기 -1 전송 후 종료 |
| 명령어 인식 실패 | "ERR " 전송 후 종료 |
| PUT 중 오류 | 저장 실패 시 소켓 종료 또는 `FAIL` 전송 |

---

## 💡 향후 확장 가능 항목

| 명령어 | 설명 |
|--------|------|
| `LIST` | 저장된 파일 목록 반환 |
| `DEL ` | 특정 파일 삭제 |
| `STAT` | 디스크 상태 또는 파일 존재 여부 확인 |
| `PING` | 헬스 체크용 |

---

## ✅ 구현 가이드 요약

- 항상 `recv()`에서 **필드 순서대로 읽어야** 함
- `ntohl()`, `htonl()` 등으로 byte order 처리
- 데이터 전송은 반드시 `send()` 루프 또는 `write()`로 전송 완료까지 반복
- 바이너리 데이터 처리 시 `fread`, `fwrite` 등 사용

---

## 📌 프로토콜 버전 관리

| 버전 | 변경 내용 |
|------|-----------|
| `v0.1` | 최초 버전 - `PUT`, `SEND` 명령만 지원 |
